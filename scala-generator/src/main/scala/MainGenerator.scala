import com.typesafe.config.{Config, ConfigFactory}
import org.apache.spark.sql.functions.{col, concat, from_json, lit}
import org.apache.spark.sql.streaming.DataStreamWriter
import org.apache.spark.sql.types._
import org.apache.spark.sql.{DataFrame, Dataset, Encoder, Row, SparkSession}

object MainGenerator extends App {
  val mainStreamConf: Config = ConfigFactory.load()

  val SPARK_MASTER      = mainStreamConf.getString("spark.master")
  val SPARK_UI_PORT     = mainStreamConf.getString("spark.ui.port")
  val BOOTSTRAP_SERVERS = mainStreamConf.getString("kafka.bootstrap.servers")
  val FRIENDS_SINK      = mainStreamConf.getString("kafka.friends.sink")
  val PROFILES_SINK     = mainStreamConf.getString("kafka.profiles.sink")

  val spark: SparkSession = SparkSession.builder()
    .appName("Generator")
    .master(SPARK_MASTER)
    .config("spark.ui.port", SPARK_UI_PORT)
    .getOrCreate()

  val schemaFriends = DataType.fromJson("{\"type\":\"struct\",\"fields\":[{\"name\":\"ctime\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"friend_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"user_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}}]}").asInstanceOf[StructType]
  val schemaProfiles = DataType.fromJson("{\"type\":\"struct\",\"fields\":[{\"name\":\"about\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"activities\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"bdate\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"birth_date\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"books\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"career.city_id\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"career.company\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"career.country_id\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"career.from\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"career.group_id\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"career.position\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"career.until\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"city_id\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"city_title\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"country_id\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"country_title\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_album_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_date\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_lat\",\"type\":\"double\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_long\",\"type\":\"double\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_max\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_max_url\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_owner_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_post_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"crop_photo_text\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"ctime\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"deactivated\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"domain\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"education_form\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"education_status\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"facebook\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"faculty\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"faculty_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"first_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"followers_count\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"games\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"graduation\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"home_phone\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"home_town\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"instagram\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"interests\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"is_closed\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"last_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"livejournal\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"maiden_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"mobile_phone\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"movies\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"music\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"nickname\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"occupation_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"occupation_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"occupation_type\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_alcohol\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_inspired_by\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_langs\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_life_main\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_people_main\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_political\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_religion\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"personal_smoking\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"photo_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"photo_max_url\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"quotes\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"relation\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"relation_partner_first_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"relation_partner_id\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"relation_partner_last_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"relatives.name\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"relatives.type\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"relatives.user_id\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.city_id\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.class\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.country_id\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.id\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.name\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.speciality\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.type\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.type_str\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.year_from\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.year_graduated\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"schools.year_to\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"screen_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"sex\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"site\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"skype\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"status\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"tv\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"twitter\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.chair\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.chair_name\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.education_form\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.education_status\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.faculty\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.faculty_name\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.graduation\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.id\",\"type\":{\"type\":\"array\",\"elementType\":\"long\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"universities.name\",\"type\":{\"type\":\"array\",\"elementType\":\"string\",\"containsNull\":true},\"nullable\":true,\"metadata\":{}},{\"name\":\"university\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}},{\"name\":\"university_name\",\"type\":\"string\",\"nullable\":true,\"metadata\":{}},{\"name\":\"verified\",\"type\":\"long\",\"nullable\":true,\"metadata\":{}}]}").asInstanceOf[StructType]

  val profiles = spark.readStream
    .schema(schemaProfiles)
    .json("C:\\studying\\itmo\\big_data_fall_2021\\bigdata-graph-warehouse\\generator\\src\\main\\resources\\user_profiles")
    .select("id", "first_name", "last_name")
    .selectExpr("CAST(id AS STRING) AS key", "to_json(struct(*)) AS value")
    .writeStream
    .format("kafka")
    .option("kafka.bootstrap.servers", BOOTSTRAP_SERVERS)
    .option("topic", PROFILES_SINK)
    .option("checkpointLocation", "C:\\tmp\\checkpoint15")

  val friends = spark.readStream
    .schema(schemaFriends)
    .json("C:\\studying\\itmo\\big_data_fall_2021\\bigdata-graph-warehouse\\generator\\src\\main\\resources\\friends")
    .select("user_id", "friend_id")
    .withColumn("id", concat(col("user_id"), lit('.'), col("friend_id")))
    .selectExpr("CAST(id AS STRING) AS key", "to_json(struct(*)) AS value")
    .writeStream
    .format("kafka")
    .option("kafka.bootstrap.servers", BOOTSTRAP_SERVERS)
    .option("topic", FRIENDS_SINK)
    .option("checkpointLocation", "C:\\tmp\\checkpoint14")

  friends.start()
  profiles.start()
    .awaitTermination()

  spark.close()
}
